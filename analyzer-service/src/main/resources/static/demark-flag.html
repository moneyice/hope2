<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hope2</title>
    <link rel="stylesheet" href="https://bulma.io/css/bulma-docs.min.css?v=202101062241">
    <link rel="stylesheet" href="https://lib.baomitu.com/bulma/0.9.1/css/bulma.css">
    <link rel="shortcut icon" href="/favicon.ico">
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://code.highcharts.com.cn/highstock/8.2.2/highstock.js"></script>
    <script src="https://code.highcharts.com.cn/highstock/8.2.2/modules/exporting.js"></script>
    <script src="https://code.highcharts.com.cn/highstock/8.2.2/modules/data.js"></script>
    <script src="https://code.highcharts.com.cn/highcharts-plugins/highcharts-zh_CN.js"></script>
    <script type="text/javascript">
        var chart;
        var profitChart;
        var path = window.document.location.href;
        var code = path.split('?')[1].split('=')[1];
        var flagLink = '/demark-backtrack/' + code;
        $(document).ready(function () {
            createChart();
            createProfitChart();
            getFlagsData(flagLink, chart,profitChart);
        });

        function createProfitChart() {
            profitChart = Highcharts.stockChart('profit-container', {
                rangeSelector: {
                    selected: 4
                },
                title: {
                    text: '定投收益率'
                },
                yAxis: {
                    labels: {
                        formatter: function () {
                            return (this.value > 0 ? ' + ' : '') + this.value + '%';
                        }
                    },
                    plotLines: [{
                        value: 0,
                        width: 2,
                        color: 'silver'
                    }]
                },
                // plotOptions: {
                //     series: {
                //         compare: 'percent'
                //     }
                // },
                tooltip: {
                    pointFormat: '<span style="color:{series.color}">收益率</span>: <b>{point.y}</b> %<br/>',
                    valueDecimals: 2,
                    split: false
                },
                series: [{
                    type: 'area',
                    name: "stock name",
                    data: [],
                    id: 'dataseries',
                    tooltip: {
                        valueDecimals: 2
                    },
                    fillColor : {
                        linearGradient : {
                            x1: 0,
                            y1: 0,
                            x2: 0,
                            y2: 1
                        },
                        stops : [
                            [0, Highcharts.getOptions().colors[0]],
                            [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                        ]
                    },
                    threshold: null
                }]
            });


        }


        function post() {
            var days = $("#days").val();
            var linkNew = flagLink + '?days2Now=' + days;
            getFlagsData(linkNew, chart,profitChart);
        }

        function createChart() {
            // Create the chart
            chart = Highcharts.stockChart('container', {
                rangeSelector: {
                    selected: 4
                },
                title: {
                    text: ''
                },
                yAxis: {
                    title: {
                        text: '价格'
                    },
                    plotLines: [{
                        id:'costPrice',
                        value: 0,
                        color: '#33AA11',
                        dashStyle: 'shortdash',
                        width: 2,
                        label: {
                            text: '定投持仓成本价格'
                        }
                    }, {
                        id:'averagePrice',
                        value: 0,
                        color: '#DD2200',
                        dashStyle: 'shortdash',
                        width: 2,
                        label: {
                            text: '观察期平均股价'
                        }
                    }]
                },
                series: [{
                    type: 'candlestick',
                    name: "stock name",
                    color: 'green',
                    lineColor: 'green',
                    upColor: 'red',
                    upLineColor: 'red',
                    navigatorOptions: {
                        color: Highcharts.getOptions().colors[0]
                    },
                    data: [],
                    id: 'dataseries',
                    tooltip: {
                        valueDecimals: 2
                    }
                },
                    {
                        type: 'flags',
                        data: null,
                        onSeries: 'dataseries',
                        shape: 'circlepin',
                        width: 16,
                        color: '#e97b25',
                        fillColor: '#e97b25',
                        style: { // text style
                            color: 'white'
                        },
                        visible: $("#bsCheckbox").is(':checked')
                    }, {
                        type: 'flags',
                        data: null,
                        onSeries: 'dataseries',
                        shape: 'circlepin',
                        width: 16,
                        color: '#ef270d',
                        fillColor: '#ef270d',
                        style: { // text style
                            color: 'white'
                        },
                        visible: $("#bcCheckbox").is(':checked')
                    }, {
                        type: 'flags',
                        data: null,
                        onSeries: 'dataseries',
                        shape: 'squarepin',
                        width: 16,
                        color: '#0def73',
                        fillColor: '#0def73',
                        style: { // text style
                            color: 'white'
                        },
                        visible: $("#ssCheckbox").is(':checked')
                    }, {
                        type: 'flags',
                        data: null,
                        onSeries: 'dataseries',
                        shape: 'squarepin',
                        width: 16,
                        color: '#0a8ff1',
                        fillColor: '#0a8ff1',
                        style: { // text style
                            color: 'white'
                        },
                        visible: $("#scCheckbox").is(':checked')
                    }]
            });
            return chart;
        }

        function getFlagsData(link, chart, profitChart) {
            Highcharts.getJSON(link, function (data) {
                var setupFlag = [];
                var countdownFlag = [];
                if (data.flag != null) {
                    for (var i = 0; i < data.flag.length; i++) {
                        //准备setup 数据
                        var setupObj = {};
                        setupObj.x = data.flag[i].setup;
                        setupObj.title = 'BS';
                        setupObj.text = '(' + data.flag[i].setupNumber + 'T,Setup) ' + data.flag[i].setupDate;
                        setupFlag.push(setupObj);
                        //准备countdown 数据
                        var countdownObj = {};
                        countdownObj.x = data.flag[i].countdown;
                        countdownObj.title = 'BC';
                        countdownObj.text = '(' + data.flag[i].countdownNumber + 'T,Countdown) ' + data.flag[i].countdownDate;
                        countdownFlag.push(countdownObj);
                    }
                }
                var sellSetupFlag = [];
                var sellCountdownFlag = [];
                if (data.flagSell != null) {
                    for (var i = 0; i < data.flagSell.length; i++) {
                        //准备setup 数据
                        var setupObj = {};
                        setupObj.x = data.flagSell[i].setup;
                        setupObj.title = 'SS';
                        setupObj.text = '(' + data.flagSell[i].setupNumber + 'T,Setup) ' + data.flagSell[i].setupDate;
                        sellSetupFlag.push(setupObj);
                        //准备countdown 数据
                        var countdownObj = {};
                        countdownObj.x = data.flagSell[i].countdown;
                        countdownObj.title = 'SC';
                        countdownObj.text = '(' + data.flagSell[i].countdownNumber + 'T,Countdown) ' + data.flagSell[i].countdownDate;
                        sellCountdownFlag.push(countdownObj);
                    }
                }

                //title
                var title = {
                    text: data.name + ' ' + data.code
                };
                chart.setTitle(title);

                //bars
                // var bars = data.bars;
                // var lines = [];
                // var dataLength = bars.length;
                // for (i = 0; i < dataLength; i++) {
                //     lines.push([
                //         bars[i][0], // the date
                //         bars[i][4] // close
                //     ]);
                // }
                // lineData = lines;
                chart.series[0].setName(data.name);
                chart.series[0].setData(data.bars);

                //flags
                chart.series[1].setData(setupFlag);
                chart.series[2].setData(countdownFlag);
                chart.series[3].setData(sellSetupFlag);
                chart.series[4].setData(sellCountdownFlag);
                //成本价格线
                chart.yAxis[0].options.plotLines[0].value=data.profit.averageCostPrice;
                chart.yAxis[0].options.plotLines[0].label.text="定投持仓成本价格"+data.profit.averageCostPrice.toFixed(2)+"元";
                chart.yAxis[0].options.plotLines[1].value=data.profit.averagePrice;
                chart.yAxis[0].options.plotLines[1].label.text="观察期平均股价"+data.profit.averagePrice.toFixed(2)+"元";
                chart.yAxis[0].update();

                //profit
                profitChart.series[0].setData(data.profit.profits);
            });
        }

        function checkboxOnclick(checkboxId, selected) {
            if (checkboxId == 'bsCheckbox') {
                chart.series[1].setVisible(selected);
            } else if (checkboxId == 'bcCheckbox') {
                chart.series[2].setVisible(selected);
            } else if (checkboxId == 'ssCheckbox') {
                chart.series[3].setVisible(selected);
            } else if (checkboxId == 'scCheckbox') {
                chart.series[4].setVisible(selected);
            }
        }

        function radioOnclick(checkboxId, selected) {
            if (checkboxId == 'candlestick' && selected) {
                chart.series[1].type = 'candlestick';
                chart.series[1].setData(barData);
            } else {
                chart.series[1].type = 'line';
                chart.series[1].setData(lineData);
            }

        }


    </script>
</head>


<body class="layout-default">
<nav id="navbar" class="bd-navbar navbar has-shadow is-spaced">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item" href="https://hope2.qianyitian.com/">
                <img style="height:36px;width:36px;" src="https://img.qianyitian.com/icon/logo.png">  <h4
                    class="title is-3">Hope2</h4>
            </a>
        </div>
    </div>
</nav>

<section class="section">
    <div class="container">
        <div class="columns">
            <div class="column is-3">
                <div class="field">
                    <label class="label">计算最近多少天的数据</label>
                    <div class="control">
                        <input id="days" class="input" type="text" name="days" value="300">
                    </div>
                </div>
                <div class="field is-grouped">
                    <div class="control">
                        <button class="button is-link" onclick="post()">Submit</button>
                    </div>
                </div>
            </div>
            <div class="column is-1">
            </div>
            <div class="column is-2">
                <div class="field-body">
                    <div class="field">
                        <div class="control">
                            <label class="checkbox">
                                <input id="bsCheckbox" type="checkbox"
                                       onclick="checkboxOnclick('bsCheckbox',this.checked)">
                                Buy-Setup 九天揽月
                            </label>
                        </div>
                    </div>
                </div>
                <div class="field-body">
                    <div class="field">
                        <div class="control">
                            <label class="checkbox">
                                <input id="bcCheckbox" type="checkbox" checked=“checked”
                                       onclick="checkboxOnclick('bcCheckbox',this.checked)">
                                Buy-Countdown 十三太保
                            </label>
                        </div>
                    </div>
                </div>

                <div class="field-body">
                    <div class="field">
                        <div class="control">
                            <label class="checkbox">
                                <input id="ssCheckbox" type="checkbox"
                                       onclick="checkboxOnclick('ssCheckbox',this.checked)">
                                Sell-Setup 九九归天
                            </label>
                        </div>
                    </div>
                </div>
                <div class="field-body">
                    <div class="field">
                        <div class="control">
                            <label class="checkbox">
                                <input id="scCheckbox" type="checkbox"
                                       onclick="checkboxOnclick('scCheckbox',this.checked)">
                                Sell-Countdown 十三惊魂
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="column is-1">
            </div>
            <!--            <div class="column is-2">-->
            <!--                <div class="field-body">-->
            <!--                    <div class="field">-->
            <!--                        <div class="control">-->
            <!--                            <label class="radio">-->
            <!--                                <input type="radio" name="answer" checked=“checked”-->
            <!--                                       onclick="radioOnclick('candlestick',this.checked)">-->
            <!--                                蜡烛图-->
            <!--                            </label>-->
            <!--                            <label class="radio">-->
            <!--                                <input type="radio" name="answer" onclick="radioOnclick('line',this.checked)">-->
            <!--                                分时线-->
            <!--                            </label>-->
            <!--                        </div>-->
            <!--                    </div>-->
            <!--                </div>-->
            <!--            </div>-->
        </div>
    </div>
</section>
<hr>
<section class="section">
    <div class="container">
        <div id="container"></div>
    </div>
</section>

<section class="section">
    <div class="container">
        <div id="profit-container" style="min-width:400px;height:400px"></div>
    </div>
</section>

<hr>
</body>
</html>
